#!/bin/sh

killall -s KILL sonyapp showLogo ui_menu

# Extract system files to avoid crashing
mkdir -p /media/mod/gaadata/system/bios
mkdir -p /media/mod/gaadata/preferences
mkdir -p /media/mod/data/AppData/sony/ui
mkdir -p /media/mod/data/AppData/sony/auto_dimmer
mkdir -p /media/mod/gaadata/databases
mkdir -p /media/mod/gaadata/geninfo
mkdir -p /media/mod/logs
mkdir -p /media/mod/data/sony/ui

# Sync database from games list
[ -f /media/mod/bin/syncdb ] && chmod +x /media/mod/bin/syncdb && /media/mod/bin/syncdb /media/games /media/mod/gaadata/databases/regional.db /media/mod/share/db/psx_games.db 1>/media/mod/logs/syncdb.log 2>&1

# Copy the BIOS files to USB
[ ! -f /media/mod/gaadata/system/bios/romw.bin ] && cp -r /gaadata/system/bios/* /media/mod/gaadata/system/bios
# Copy the regional.pre to USB
# This contains settings for the UI region
[ ! -f /media/mod/gaadata/preferences/regional.pre ] && cp /gaadata/preferences/* /media/mod/gaadata/preferences
# Copy out the user.pre to USB
# This contains things like language setting
[ ! -f /media/mod/data/AppData/sony/ui/user.pre ] && cp /data/AppData/sony/ui/* /media/mod/data/AppData/sony/ui
# Copy out the auto dimming config to USB
[ ! -f /media/mod/data/AppData/sony/auto_dimmer/config.cnf ] && cp /data/AppData/sony/auto_dimmer/* /media/mod/data/AppData/sony/auto_dimmer
# Copy out the region info
[ ! -f /media/mod/gaadata/geninfo/REGION ] && cp /gaadata/geninfo/* /media/mod/gaadata/geninfo
# Copy ui error log
[ ! -f /media/mod/data/sony/ui/error.log ] && cp /data/sony/ui/* /media/mod/data/sony/ui
# Init the ui_menu.log
[ ! -f /media/mod/logs/ui_menu.log ] && touch /media/mod/logs/ui_menu.log
sync

# Unmount partitons and create tmpfs - Shut system down on failure
MOUNT_FAIL=0
umount /data || MOUNT_FAIL=1 
umount /gaadata || MOUNT_FAIL=1 
# Create gaadata and data folders in tmp then mount over original folders
mkdir -p /tmp/gaadatatmp /tmp/datatmp
mount -o bind /tmp/gaadatatmp /gaadata || MOUNT_FAIL=1 
mount -o bind /tmp/datatmp /data || MOUNT_FAIL=1 
mount -o bind /media/mod/etc/udev/rules.d/20-joystick.rules /etc/udev/rules.d/20-joystick.rules || MOUNT_FAIL=1 
[ $MOUNT_FAIL -eq 1 ] && reboot && exit

# Create gaadata on tmpfs
ln -sf /media/mod/gaadata/* /tmp/gaadatatmp/
ls /media/games | grep '^[0-9]\+$' | xargs -I % sh -c "ln -s /media/games/%/GameData /tmp/gaadatatmp/% && mkdir -p /media/games/%/.pcsx && cp /media/games/%/GameData/pcsx.cfg /media/games/%/.pcsx"

# Create data on tmpfs
mkdir -p /tmp/datatmp/sony/sgmo /tmp/datatmp/AppData/sony
ln -s /media/mod/data/AppData/sony/ui /tmp/datatmp/AppData/sony/ui
ln -s /media/mod/data/AppData/sony/auto_dimmer /tmp/datatmp/AppData/sony/auto_dimmer
ln -s /media/mod/data/sony/ui /tmp/datatmp/sony/ui
ln -s /tmp/diag /tmp/datatmp/sony/sgmo/diag
ln -s /dev/shm/power /tmp/datatmp/power
cp -r /usr/sony/share/recovery/AppData/sony/pcsx /tmp/datatmp/AppData/sony/pcsx
ls /media/games | grep '^[0-9]\+$' | xargs -I % sh -c "rm -rf /tmp/datatmp/AppData/sony/pcsx/% && ln -s /media/games/% /tmp/datatmp/AppData/sony/pcsx/%"
ln -s /media/mod/gaadata/system/bios /tmp/datatmp/AppData/sony/pcsx/bios
ln -s /usr/sony/bin/plugins /tmp/datatmp/AppData/sony/pcsx/plugins

# Fix for last selected game issue. If not in place user may experience UI issue
sed -i "s/iUiUserSettingLastSelectGameCursorPos.*/iUiUserSettingLastSelectGameCursorPos=0/" /tmp/datatmp/AppData/sony/ui/user.pre
# Uncomment this to force not reversing O and X (like JP models)
# sed -i 's/bUiSystemSettingReverseEnterKey=true/bUiSystemSettingReverseEnterKey=false/' /tmp/gaadatatmp/preferences/regional.pre

# Reload and apply udev rules that were overmounted above
# Allows both controllers to be detected through a USB hub
udevadm control --reload-rules
udevadm trigger

# Fix for line endings. BAD WINDOWS
find /media/mod -name *.cfg -exec sed -i 's/\r//g' {} \;
find /media/mod -name *.pre -exec sed -i 's/\r//g' {} \;

# Default pcsx.cfg
cd /media/Games
for D in *; do
    if [ -d "${D}" ]; then
        if [ ! -f "${D}/GameData/pcsx.cfg" ]; then
            cp /media/mod/share/defaults/pcsx.cfg "${D}/GameData/pcsx.cfg"
        fi
        if [ ! -f "${D}/GameData/cover.png" ]; then
            cp /media/mod/share/defaults/cover.png "${D}/GameData/cover.png"
        fi
    fi
done
cd -

cd /data/AppData/sony/pcsx
export PCSX_ESC_KEY=2
/usr/sony/bin/ui_menu --power-off-enable &> /media/mod/logs/ui_menu.log
sync
sync
reboot
